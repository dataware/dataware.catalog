<html>
<head>
	<script type="text/javascript" src="jquery-1.6.min.js"></script>
	<script type="text/javascript" src="distillation.js"></script>
	<script type="text/javascript" src="parser.js"></script>
	<script>

	/** 
	 * This is the Controller Script for the Google Chrome Datware.
	 * It receives requests from the content and popup scripts.
	 * TODO: Should keep track of web-history, to check that a web page is not being repeatedly read (also solves back button problem)
	 * TODO: Keep track of IP Address
	 */


	//-- Setup constants that will be required
	DOCUMENT_TYPE = "web";
	APPLICATION_NAME = "Google Chrome";
	COOKIE_NAME = "logged_in"
	PREFSTORE =  "http://localhost:8080/";
	
	//-- A list of domains that won't be parsed (predominantly search engines)
	IGNORE_LIST = new Array( "www.bing", "www.google", "search.yahoo", "ask.com", "search.aol" )

	window.localStorage.setItem( "cookie_name", COOKIE_NAME );
	window.localStorage.setItem( "prefstore", PREFSTORE );
	//"http://ec2-79-125-74-77.eu-west-1.compute.amazonaws.com:8080/";
	
	//-- initialize by parsing the extensions corresponding cookie	
	parse_cookie()
	
	
	//-- Listener to receive word vectors from the content script.
	chrome.extension.onRequest.addListener(
		function( request, sender, sendResponse ) {
			processVector( request.text, sender.tab.url, sender.tab.title );
		}
	);
	
			
	//-- setup a listener so that if cookies change we refresh the page
	chrome.cookies.onChanged.addListener( 
		function( info ) { parse_cookie() }
	);
	
	
	//-- determine whether the user is logged in
	function parse_cookie() {
		a = chrome.cookies.get(
			{ "url" : PREFSTORE, "name" : COOKIE_NAME },
			function( cookie ) {
			
				window.localStorage.removeItem( "user_id" );
				window.localStorage.removeItem( "screen_name" );
				
				if ( cookie ) {
					jsonString = eval( cookie.value )
					data = eval( '(' + jsonString + ')' )
					
					if ( data.user_id ) {
						window.localStorage.setItem( "user_id", data.user_id );
					}
					
					if ( data.screen_name ) {
						window.localStorage.setItem( "screen_name", data.screen_name );
					}
				}

				user_id = window.localStorage.getItem( "user_id" );
				screen_name = window.localStorage.getItem( "screen_name" );
				
				refresh();
			}
		);
	}


	//-- the init function (called refresh as it is called every time
	//-- something changes - namely cookie updates.
	function refresh() {
		
		//--retrieve and fill the global variables
		user_id = window.localStorage.getItem( "user_id" );
		screen_name = window.localStorage.getItem( "screen_name" );
		
		//-- Make sure the correct favicon is displayed
		if ( user_id && screen_name ) {
			chrome.browserAction.setIcon( { path:"icon.png" } );
		} else {
			chrome.browserAction.setIcon( { path:"icon-dormant.png" } );
		}
	}
	

	/*
	 *
	 */
	function isIgnored( url ) {

		//-- check whether the url contains an ignore_list match.
		for ( i=0; i < IGNORE_LIST.length; i++ )
			if ( url.indexOf( IGNORE_LIST[ i ] ) != -1 )
				return true;

		return false;
	}

	
    /**
     * Main entry point to the script - contentScript.js essentially 
	 * bundles up the text from a web page ready for parsing, and 
	 * transmitting to the prefstore
	 */
	function processVector( text, url, title ) {
	
		//--retrieve and fill the global variables
		var user_id = window.localStorage.getItem( "user_id" );
		var screen_name = window.localStorage.getItem( "screen_name" );
		
		//-- if the user is logged in (and we have their details, then we 
		//-- can organize sending the data to their prefstore. Otherwise
		//-- for the moment we discard it
		
		if ( user_id && screen_name )  {

			//-- determine whether the page passes the ignore_list
			if ( !isIgnored( url ) ) 
			{

				//-- parse the text with min_word_length 3, min_support 3
				doc = new Parser( text, 3, 3 );
				
				//-- create the distillation object (default duration to 10s for now)
				var distillation = new Distillation( doc.fv, url, 10, title, doc.totalWords );
				
				//-- store the current page being observed, for the stats dropdown.
				window.localStorage.setItem( "lastPage", distillation.stringify() );
				window.localStorage.setItem( "lastPageStatus", null );
				incrementUserStat( "pagesAnalysed" );
				
				//-- transmit to the prefstore
				chrome.browserAction.setIcon( { path:"icon-progress.png" } );
				
				transmitDistillation( distillation );
				incrementUserStat( "pagesSent" );
			}
		}	
	}
	

	/**
     * Using AJAX, transmit the vector to the user's prefstore.
	 */
	function transmitDistillation( distillation ) {

		user_id = window.localStorage.getItem( "user_id" );
		data = "user_id=" + user_id + "&data=" + distillation.stringify();

		//-- attempt to send the distill to the prefstore
		jQuery.ajax({ 
			type : "POST", 
			data : data ,
			url : PREFSTORE + "submitDistill", 
			cache : false,
			timeout : 30000,
			error : function( data ) { transmitFailure( distillation, data ); },
			success : function( data ) { transmitSuccess( distillation, data ); }
		});
	}

	
	/**
     * When a transmission is successful, we still need to check whether
	 * the distillation was successfully processed by the server
	 */
	function transmitSuccess( distillation, response ) {
		
		//-- parse the response
		var result = eval( '(' + response + ')' ); 

		if ( result.success ) {
			processSuccess( distillation );
		}
		else {
			processFailure( distillation, "delivery failure: " + result.cause );
		}
	}


	/**
     * The following function is fired when for some reason the distillation
	 * that we packaged up and sent did not reach the server
	 */
	function transmitFailure( distillation, response ) {

		//-- Error find the submitDistill endpoint
		if ( response.status == 404 ) {
			processFailure( distillation, "delivery failure - API unreachable (404)" );
		}

		//-- Error reaching the server
		else if ( response.status == 0 ) {
			processFailure( distillation, "delivery failure - Server unreachable (OOO)" );
		}

		//-- An unknown error has occurred
		else {
			processFailure( distillation, "delivery failure - Cause unknown (" + response.status + ")" );
		}
	}


	/**
     * When a failure occurs we can cache the page visited and try again later
	 */
	function processSuccess( distillation ) {

		//-- TODO: change the logo to a tick for this page.
		chrome.browserAction.setIcon( { path:"icon-success.png" } );
		chrome.browserAction.setBadgeText( { text:"" } );

		//-- update user statistics
		incrementUserStat( "pagesComplete" );

		//-- change last page to be successfully sent
		window.localStorage.setItem( "lastPageStatus", "delivered successfully" );

		//-- no. distillations
	}


	/**
     * When a failure occurs we can cache the page visited and try again later
	 */
	function processFailure( distillation, cause ) {

		//-- update the favicon information to reflect the failure
		chrome.browserAction.setIcon( { path:"icon-failure.png" } );
		chrome.browserAction.setBadgeText({text:""});
		
		//-- specify that the "last page" failed
		window.localStorage.setItem( "lastPageStatus", cause );
	}


	/**
	 * Update user statistics by first retrieving them from the data store
	 * before simply incrementing, and rewriting back to the local data store
	 */
	function incrementUserStat( parameter ) {
		amount = window.localStorage.getItem( parameter );
		if ( !amount ) amount = 0;
		window.localStorage.setItem( parameter, ++amount );
	}
	</script>

</head>
</html>